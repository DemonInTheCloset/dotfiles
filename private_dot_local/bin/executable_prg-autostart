#!/bin/sh
[ -z "$1" ] && echo "No program provided" > /dev/stderr && exit 1

PRG_NAME="$1"
shift
PRG_ARGS=$( IFS=$(printf ' '); echo "$@" )
PRG_PATH="$(which "$PRG_NAME")"

SYSTEMD_USER="${XDG_CONFIG_HOME:-"$HOME"/.config}"/systemd/user
SERVICE_NAME="$PRG_NAME".service
SERVICE_PATH="$SYSTEMD_USER/$SERVICE_NAME"

[ -z "$PRG_PATH" ] && exit 1

[ -d "$SYSTEMD_USER" ] || mkdir -v -p "$SYSTEMD_USER"

[ -e "$SERVICE_PATH" ] && echo 'Unit '"$SERVICE_PATH"' exists' > /dev/stderr && exit 1

printf '[Unit]\nDescription=Autostart %s\n\n[Service]\nExecStart=%s %s\n' \
    "$PRG_NAME" "$PRG_PATH" "$PRG_ARGS" > "$SERVICE_PATH"

systemctl --user --dry-run add-wants autostart.target "$SERVICE_NAME"
